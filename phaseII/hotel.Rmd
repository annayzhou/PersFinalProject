---
title: "Hotel"
author: "Yunwen Cai"
date: "October 27, 2017"
output: html_document
---

```{r}
library(data.table)
dat = fread("~/Desktop/0-Personalization Theory/Project/train1.csv")
user.number = length(unique(dat$user_id))
user.srs = sample(1:user.number,50000)
dat.subset = dat[which(dat$user_id %in% user.srs),]
clusters = table(dat.subset$hotel_cluster)
barplot(clusters)
write.csv(dat.subset,"~/Desktop/0-Personalization Theory/Final_Project/subset50k.csv")
dat.subset$date_time
dat.subset$search_year = as.integer(substr(dat.subset$date_time,1,4))
dat.subset$search_month = as.integer(substr(dat.subset$date_time,6,7))
dat.subset$search_date = as.integer(substr(dat.subset$date_time,9,10))
dat.subset$ci_year = as.integer(substr(dat.subset$srch_ci,1,4))
dat.subset$ci_month = as.integer(substr(dat.subset$srch_ci,6,7))
dat.subset$ci_date = as.integer(substr(dat.subset$srch_ci,9,10))

srch_ci <- as.Date(dat.subset$srch_ci)
srch_co <- as.Date(dat.subset$srch_co)
duration = as.integer(srch_co - srch_ci)

dat.subset$duration = duration
dat.subset = dat.subset[,-c("date_time","srch_ci","srch_co")]

write.csv(dat.subset,"~/Desktop/0-Personalization Theory/Final_Project/subset100k.csv")

##----------------------------------------------------------
library(data.table)
dat.subset = fread("~/Desktop/Project/subset_numeric.csv")

dat.no.na = dat.subset[complete.cases(dat.subset), ]
dat.no.response = dat.no.na[,-c("hotel_cluster","V1")]
pca <- prcomp(dat.no.response,center = TRUE,scale. = TRUE)
plot(pca$sdev^2/sum(pca$sdev^2))
plot(cumsum(pca$sdev^2)/sum(pca$sdev^2), main='Cumulative proportion of variance explained', xlab='Number of components',ylab='Proportion of variance explained')

library(randomForest)
randomForest(hotel_cluster~.,data=dat.no.na)

clusters.org = table(dat$hotel_cluster)
barplot(clusters.org)

n = nrow()
mat = matrix(0,nrow=length(unique(dat.subset$user_id)),ncol=length(unique(dat.subset$hotel_cluster)))
for (i in 1:n) {
  
}

dat = fread("~/Desktop/0-Personalization Theory/Project/subset.csv")
```

```{r}
# 10k data, neighborhood size from 2 to 150
rmse=c(0.45526136637234266, 0.45023287807886919, 0.44876751468549037, 0.44575592007961262, 0.44825356703696606, 0.44252798105783181, 0.44357187128897191, 0.44301838355677264, 0.4392272319197465, 0.43890490222560602, 0.44120507495805139, 0.43719651231299822, 0.44060625290089239, 0.44142300890264236, 0.44037863521344489, 0.44221245159616995, 0.43459514018502093, 0.44028691667658987, 0.43748900664907808, 0.43628189726566341, 0.43468633617767766, 0.4361248777097938, 0.43688526697557234, 0.43273394326683767, 0.43429285516176963, 0.43053624854114314, 0.43122900053414392, 0.4320419940487043, 0.42726978958760442, 0.42657440450864642, 0.42708947412306325, 0.42610336932483206, 0.42540759476423462, 0.42435489261561887, 0.42700473763755947, 0.42747659432134782, 0.42401135324680983, 0.42652342409701316, 0.42977278364245236, 0.43026861992877991, 0.42444173217262443, 0.42654591932664243, 0.42745885489108842, 0.42736322775704549, 0.42510952824346154, 0.42269974837342328, 0.42497973093120567, 0.42596258464521641, 0.42305247171916471, 0.42696660210609438, 0.42916193356936516, 0.42559323156081297, 0.42421976968937447, 0.42361530004511494, 0.4269825977038334, 0.42406784972893574, 0.42352623956060897, 0.42522197840512777, 0.42341210775789229, 0.42830025333624377, 0.42325140222796626, 0.42437335135720311, 0.42384532293678784, 0.4225553081553457, 0.42282529563019944, 0.42798976125395571, 0.42177099971050291, 0.42635247394855325, 0.42368630487294451, 0.42676059881988737, 0.42189598993485344, 0.42351822570714226, 0.42463140825172674, 0.42346586112320733, 0.42034454631372825, 0.42548319611427637, 0.42345274628593543, 0.42492647361591895, 0.4224164421877023, 0.42339670909977273, 0.42203507879165852, 0.42587638651219067, 0.42258156711174211, 0.42356575952704284, 0.42255283885922001, 0.42341292623126731, 0.42317752002415326, 0.42237447163635611, 0.42443504925188458, 0.42029962288732969, 0.42252274794968214, 0.42077331334085777, 0.42191285045034244, 0.42390684800931755, 0.425814859234867, 0.42150581998292713, 0.42725718254693862, 0.42509931295950742, 0.42359849500285857, 0.42313679661441383, 0.42554428707298719, 0.42023538470949146, 0.42296893514644573, 0.42425152337959277, 0.42469793336585626, 0.42167646950445159, 0.42238882669048772, 0.42681081311376168, 0.42272625218237592, 0.42003812315672534, 0.42352334112399648, 0.42126056672392415, 0.42068904913329658, 0.42312356108759913, 0.42101781831875557, 0.42190578441597443, 0.42009167130342567, 0.41943648613082091, 0.41941305555993813, 0.42016068395260364, 0.42056571211224536, 0.42147722894894041, 0.42600475839359769, 0.42147197485553034, 0.42367327112414249, 0.42401779036281295, 0.42116768926783754, 0.42406182906666123, 0.42056587332022322, 0.42342531069888095, 0.42053589627472532, 0.42108254087503794, 0.41909967463830045, 0.42022868892631465, 0.42263111947468274, 0.41987168589295021, 0.41945352940542219, 0.42252875389846289, 0.42498677972535609, 0.42028091371146264, 0.42088242148436439, 0.41977637269354651, 0.42737273152861538, 0.42048936784861751, 0.42107516499930442, 0.41935154133942093, 0.42017138726602032, 0.42012112642813004, 0.42116148709919654)
plot(rmse,type="l",xlab = "Neighborhood Size",ylab="RMSE",main = "RMSE vs Neighborhood Size (Number of Trees = 20)")

# number of trees from 2 to 40
num_trees = c(0.4232714547901183, 0.42991164693813178, 0.42453572528174754, 0.42550024902795647, 0.42454490040516007, 0.42678333078426078, 0.4216642212064331, 0.43003605566945147, 0.42703885434764316, 0.42473807713969725, 0.42660689344363167, 0.42807394345795641, 0.42707011136847495, 0.42553996257389243, 0.42709796407659029, 0.42681592632856802, 0.42603263780318157, 0.42685085073535289, 0.42939245611341736, 0.4268812649827044, 0.42781507679801728, 0.43149587974506576, 0.42571378117694481, 0.42865746341476418, 0.42765975781648302, 0.43007510574307056, 0.42917999462180001, 0.42779949359605263, 0.42569610211839226, 0.42994851904253295, 0.42506882843794785, 0.42532277998363427, 0.43134966800534819, 0.42463289272908555, 0.42755287167572459, 0.42579676072659184, 0.42606437082062187, 0.43259136592017633, 0.42653315261190039)
plot(num_trees,type="l",xlab = "Number of Trees", ylab="RMSE", main="RMSE vs Number of Trees (Neighborhood Size = 38)")

# chose k = 38
which(rmse == 0.42401135324680983)

#pop_items_result_matrix = c(61 58 46 41 31 43 60 70 62 80)
#pop_items_orig_matrix = c(77 37 80 58 43 20 62 70  1 49)
recommended_items_result_matrix = 100
recommended_items_orig_matrix = 100
num_same_recommendation = 9377


```

```{r}

```

```{r}
# neighborhood size from 2 to 70, braching factor = 10
num_neghbors = c(0.44893570316208276, 0.44163438462949439, 0.43317453593944133, 0.43771943392017409, 0.43054385370417519, 0.42753031227682425, 0.42110027868258798, 0.4223484283438298, 0.42222053010890193, 0.42112234026445539, 0.41729475827349816, 0.42070683449077634, 0.41827064826417953, 0.41460161206726209, 0.41970566811754911, 0.41219584203731757, 0.41560578245108137, 0.41130049564715765, 0.41263881929844698, 0.41109974215555722, 0.41347398557998732, 0.41078620751233058, 0.41022597855189485, 0.41000744569688391, 0.40970960882494667, 0.40600723626673962, 0.40681610580409994, 0.40793123345923654, 0.40484926620412381, 0.40450908649877321, 0.40845960723175889, 0.40669422693066026, 0.40672041687755056, 0.40419401835259361, 0.40336094426465269, 0.40294813509377808, 0.40540806648015837, 0.40207050592965504, 0.40375555473037217, 0.40358492437326132, 0.40522701877867451, 0.40577804901968967, 0.40564413781014663, 0.40635799702598446, 0.40407758972508584, 0.40370860178846624, 0.40341814009633953, 0.40689866868899233, 0.40395948534686282, 0.40662503782703735, 0.40322131306189368, 0.39940582270758906, 0.4076922450266095, 0.40320316768608533, 0.40305588609333692, 0.40004621532772167, 0.40631817729382513, 0.40380546956603813, 0.40222929877008734, 0.40339985071545825, 0.4037735354687883, 0.40168446485501674, 0.40299298720714605, 0.40404780687509811, 0.40324522493183529, 0.40528652389130559, 0.40311584064235051, 0.40626921731162735, 0.40363600942775546)
plot(num_neghbors,type="l",xlab = "Neighborhood Size",ylab="RMSE",main="RMSE vs Neighborhood Size (Braching = 10)")
```

```{r}
# branching size from 2 to ,50 neighborhood size=38
num_branching = c(0.45499958708407756, 0.4423747821957863, 0.43536582463953505, 0.43392354959165386, 0.42973538834187225, 0.42513110613572075, 0.42564531397455702, 0.42084833137345196, 0.42067908485867012, 0.41828058775661364, 0.42061701797953982, 0.41763228311165407, 0.420461802151605, 0.41910163991455568, 0.41368408691060854, 0.41608465645783621, 0.41484094313356812, 0.41181224204953126, 0.40591588891123387, 0.41061486580740264, 0.4110795173417241, 0.4134281319525373, 0.41052347679049389, 0.40869337254127969, 0.40529597900179593, 0.40798609310249867, 0.40911899025413689, 0.40797369391368415, 0.40797630455181444, 0.40892239808912906, 0.41024106541186989, 0.40565735325994101, 0.40931805065555027, 0.40469262985082982, 0.40578101007323031, 0.40634122188720312, 0.40242089662048919, 0.40404228701973077, 0.40377035481762313, 0.40172073076297005, 0.40414822219695096, 0.40391673335045269, 0.40338821123496882, 0.40594775482014578, 0.40388316141067754, 0.40190395445554605, 0.4032742464959761, 0.40595622616913368, 0.40306366554146145)
plot(num_branching,type="l",xlab="Branching",ylab="RMSE",main="RMSE vs Branching (Neighborhood Size = 38)")

#[77  0 80 60 20 43 62 70  1 49]
#[77 37 80 58 43 20 62 70  1 49]
num_same_recommendation = 8929
```

```{r}
svd_10k_rmse=c(0.53815453904478416, 0.53816455447927303, 0.53846821695022284, 0.53830527355435631, 0.53838806027764152, 0.53804461933607983, 0.53805971331156111, 0.53866079134675382, 0.53840116349171718, 0.53789145450787346, 0.53786239016976667, 0.53837283914811462, 0.5384439009002957, 0.53855403906041832, 0.53775829303003952, 0.53845546868291239, 0.53838373785024962, 0.53876979285212601, 0.5387814281465696, 0.53864811756196562, 0.53905097258737844, 0.53877365633286134, 0.53787026987839848, 0.53847649540972031, 0.53851504264414474, 0.53870917665251694, 0.53897037791879021, 0.5386593847916854, 0.53813903192912171, 0.53820561492657748, 0.53834735978262893, 0.53790779275081524, 0.53781158487100711, 0.53886149019200391, 0.53829768715994475, 0.53911294084677042, 0.53891093323952843, 0.53835923646238815, 0.53902797880867148, 0.53829602801163945, 0.53832537625185517, 0.53882125256228064, 0.53858065712004599, 0.53791109621787569, 0.53876019380437401, 0.53803178465137658, 0.53867456441670691, 0.53850863317805331, 0.5386712105396394, 0.53852318973546986, 0.53907993659775977, 0.53817958306342284, 0.53865344128225112, 0.53870876241778531, 0.53875318379933945, 0.53913344292916765, 0.53865239298019962, 0.53846370526775722, 0.53850340878107406, 0.53869754854647389, 0.53895623654368285, 0.53791200118484817, 0.5385280007480493, 0.53873317750627192, 0.53893783891314528, 0.53894172768839277, 0.53801455754862793, 0.53839974732971507, 0.53886565087037508, 0.5385176017065344, 0.53955024026064513, 0.53814233075611717, 0.53850874362658063, 0.53897696976716725, 0.53891085621677881, 0.5388537261749986, 0.53839474917279839, 0.53878040089236012, 0.53914823630807818, 0.53860010331461816, 0.53850453517677865, 0.53853473153835651, 0.53825281491883337, 0.53950653191742359, 0.53878784812945424, 0.53874464905581643, 0.53832640724772607, 0.53877858499007458, 0.53845300068039581, 0.53842049501706968, 0.53913133164671723, 0.53882334991697944, 0.53810257932283423, 0.53903982380641924, 0.53868322851176931, 0.53892369040876242, 0.539013026840792, 0.53914760865690348, 0.53829420036637632)
svd_10k_rmse = svd_10k_rmse[1:49]
baseline_10k=0.538793
which.min(svd_10k_rmse)

plot(svd_10k_rmse,type="l",xlab="k",ylab="RMSE",main="RMSE vs k (SVD)")
abline(h=baseline_10k,lty=2)
abline(v=which.min(svd_10k_rmse),lty=3,col=2)
text(19,0.538,"k=15",col=2,cex=1.5)
legend("topleft",c("RMSE","Baseline"),lty=c(1,2))

```

```{r}
svd_100k_rmse=c(0.53842057435723223, 0.53841755853030793, 0.53859708798658956, 0.53840002045627489, 0.53857749095301499, 0.53886163420106403, 0.53813122095287647, 0.53820025722085973, 0.53849839020744295, 0.53794489939033063, 0.53817026058362649, 0.53809533105021456, 0.53818657564083172, 0.53777378371394868, 0.53811074099156964, 0.53824928974222952, 0.53827210037845463, 0.53837483140209152, 0.53789623714720458, 0.53815602307251964, 0.53780923938389136, 0.53834424061998298, 0.53872737134741333, 0.53834078864050705, 0.53957453231642594, 0.53841503174123606, 0.53808405628035971, 0.5386741291060978, 0.53843719539619062, 0.53847618582521817, 0.53816735301005181, 0.53838001342621777, 0.53847075394896138, 0.53871837210729312, 0.53810061842619961, 0.53868959965090268, 0.53794906137976517, 0.5384595162235204, 0.53837130426823543, 0.53851294957938667, 0.53819360725680243, 0.53870180634707165, 0.53847438683460358, 0.53800571470233116, 0.53909087531189026, 0.53838296704437005, 0.53860950540935026, 0.53795359644277174, 0.5387943085907726)
svd_100k_rmse = svd_100k_rmse[1:49]
baseline_100k=0.538793
which.min(svd_100k_rmse)

plot(svd_100k_rmse,type="l",xlab="k",ylab="RMSE",main="RMSE vs k (SVD++)")
abline(h=baseline_100k,lty=2)
abline(v=which.min(svd_100k_rmse),lty=3,col=2)
text(17,0.53855,"k=14",col=2,cex=1.5)
legend("topleft",c("RMSE","Baseline"),lty=c(1,2))

```

```{r}
svd_10k_elapsed=c(7.012542204000056, 7.066041683778167, 7.138105422258377, 7.283956381026655, 7.357956611085683, 7.396020343992859, 7.5459485673345625, 7.832515257876366, 7.823529238812625, 7.970796496141702, 7.960863541811705, 7.794127142988145, 8.149430152960122, 8.245958456769586, 8.406372531317174, 8.42071136040613, 8.492656550835818, 8.672335555311292, 8.758029602002352, 8.817005979828537, 8.820593107957393, 8.891171579714864, 9.129202059935778, 9.253758712206036, 9.268861957360059, 9.262660273816437, 9.301329149864614, 9.45124770514667, 9.538897424004972, 9.651295294985175, 9.702629337087274, 9.708107649814337, 9.66735186893493, 9.886324174702168, 10.291620441712439, 10.303898084908724, 10.401968305930495, 10.684106431901455, 10.574133035726845, 10.569945878814906, 10.95832950109616, 11.14314749930054, 11.062146782875061, 11.402165872976184, 11.381846957840025, 11.600852508097887, 11.634241410996765, 11.862913244403899, 12.235857180785388, 11.990578996948898, 12.02084194496274, 12.267035462893546, 12.223383408039808, 12.543292716611177, 12.926853919867426, 12.685473175253719, 12.919442862272263, 12.923104368150234, 12.963334487751126, 12.970477037597448, 13.202107551973313, 13.246285991743207, 13.272763729095459, 13.453466364182532, 13.446966181974858, 13.660466170869768, 13.412906534969807, 13.422566497698426, 13.486003802157938, 13.781266510020941, 13.618435990996659, 14.147922481875867, 14.026058355346322, 14.310790735762566, 14.771193065214902, 14.615990124177188, 15.384279654361308, 15.284930459223688, 14.65274029923603, 14.917712010908872, 15.113929139915854, 15.15121716586873, 15.727766754105687, 15.40993272792548, 15.584930114913732, 15.414423868060112, 15.867340364959091, 15.791798361111432, 15.965936789289117, 16.21517439140007, 15.844588447362185, 16.56978938775137, 16.608598452061415, 16.437383429147303, 16.409807222895324, 16.45089309103787, 16.865397098939866, 17.03428322216496, 16.890567154157907)
svd_10k_elapsed = svd_10k_elapsed[1:49]

plot(svd_10k_elapsed,type="l",xlab="k",ylab="Run Time",main="Run Time vs k (SVD)")
abline(v=15,lty=3,col=2)
text(19,10,"k=15",col=2,cex=1.5)

```

```{r}
svd_100k_elapsed=c(58.97477816231549, 57.682353786192834, 63.31855883821845, 69.24165259907022, 69.87194574996829, 71.43906741309911, 73.01586047932506, 74.06077407486737, 76.48705606302246, 79.11451301118359, 78.25826219376177, 77.0853764298372, 78.39231508318335, 80.9944814760238, 83.05262434110045, 83.86454715114087, 84.70949891675264, 86.44646245520562, 88.13703959714621, 90.8687552632764, 93.33871746109799, 95.54215154284611, 100.88680748129264, 103.5217431676574, 105.5071086389944, 107.42950164480135, 108.47151069995016, 111.76418547844514, 111.10616646520793, 113.4890549769625, 116.462610070128, 116.72165641281754, 120.08784801699221, 123.65499100415036, 120.90287664392963, 126.86121128732339, 126.94255871325731, 128.4177904422395, 130.70346442982554, 132.37467445386574, 136.8365825866349, 135.39603046001866, 140.66416139900684, 138.3227225751616, 141.98651278112084, 140.85587541526183, 144.76622860273346, 145.40502360882238, 148.12213210808113)
svd_100k_elapsed = svd_100k_elapsed[1:49]

plot(svd_100k_elapsed,type="l",xlab="k",ylab="Run Time",main="Run Time vs k (SVD++)")
abline(v=14,lty=3,col=2)
text(18,100,"k=14",col=2,cex=1.5)

```

```{r}
x = c(1,2,4,5,10,20,25,50,100)
rt = c(114.7693121433258, 118.0986340045929, 123.17016100883484, 125.84952402114868, 162.07170391082764,366.38730001449585, 416.6616520881653, 600.303719997406, 1182.8339221477509)
RMSE = c(0.4793852804361218, 0.4793852804361218, 0.4793713212655214, 0.4793931605856193, 0.4760499302319335,0.4764934573450613, 0.47714061799375934, 0.47667425483016834, 0.4787068150970586)
SimilarRe = c(9846,9846,9846,9846,9865,9843,9834,9848,9843)
SameRe = c(9561,9561,9561,9561,9541,9537,9565,9548,9561)
plot(x=x,y=rt,type="l",xlab="Band Size",ylab="Run Time",main="Run Time vs Band Size")
plot(x=x,y=RMSE,type="l",xlab="Band Size",ylab="RMSE",main="RMSE vs Band Size")
plot(x=x,y=SimilarRe,type="l",xlab="Band Size",ylab="Recommendation",main="Recommendation vs Band Size",ylim=c(9530,10000))
lines(x=x,y=SameRe,lty=2)
legend("topright",c("Similar Recommendation","Same Recommendation"),lty=c(1,2))
```

```{r}
x = c(100,150,200,250)
rt = c(279.00646686553955, 295.9806489944458, 217.80261516571045, 236.7578501701355)
RMSE = c(0.4779302136215189, 0.47796850938764995, 0.4774147188200641, 0.47757081616743113)
SimilarRe = c(9845,9845,9841,9841)
SameRe = c(9517,9528,9556,9559)
plot(x=x,y=rt,type="l",xlab="Permutation Size",ylab="Run Time",main="Run Time vs Permutation Size")
plot(x=x,y=RMSE,type="l",xlab="Permutation Size",ylab="RMSE",main="RMSE vs Permutation Size")
plot(x=x,y=SimilarRe,type="l",xlab="Permutation Size",ylab="Recommendation",main="Recommendation vs Permutation Size",ylim=c(9510,10000))
lines(x=x,y=SameRe,lty=2)
legend("topright",c("Similar Recommendation","Same Recommendation"),lty=c(1,2))
```

```{r}
x = c(0.3,0.5,0.6,0.7,0.75,0.8,0.85,0.9)
rt = c(445.6079978942871,357.82652592658997,321.96621799468994,261.2945468425751,161.45379185676575,494.16289806365967,132.20350003242493,131.3196258544922)
RMSE = c(0.47574122340328406,0.4762085229177421,0.47403583046303394,0.46985115651021614,0.47448122146958793,0.47302922811704584,0.46959715585161155,0.46947800260965467)
SimilarRe = c(9484,9850,9818,9849,9850,9850,9857,9857)
SameRe = c(9560,9567,9566,9555,9567,9555,9545,9543)
plot(x=x,y=rt,type="l",xlab="Threshold",ylab="Run Time",main="Run Time vs Threshold")
plot(x=x,y=RMSE,type="l",xlab="Threshold",ylab="RMSE",main="RMSE vs Threshold")
plot(x=x,y=SimilarRe,type="l",xlab="Threshold",ylab="Recommendation",main="Recommendation vs Threshold",ylim=c(9475,10050))
lines(x=x,y=SameRe,lty=2)
legend("topright",c("Similar Recommendation","Same Recommendation"),lty=c(1,2))
```





























